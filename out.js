(()=>{var C=1e3,b=C/4,je=32.5,A=40,F=30,Je=295,Qe=422,Ze=.2,et=.4,tt=.16,nt=.5,ot=.16,X=b/4,we=.5,it=.25,se={path2d:new Path2D("M364,-252c-245,0 -364,165 -364,339c0,202 153,345 297,464c12,10 11,12 9,24c-7,41 -14,106 -14,164c0,104 24,229 98,311c20,22 51,48 65,48c11,0 37,-28 52,-50c41,-60 65,-146 65,-233c0,-153 -82,-280 -190,-381c-6,-6 -8,-7 -6,-19l25,-145c3,-18 3,-18 29,-18c147,0 241,-113 241,-241c0,-113 -67,-198 -168,-238c-14,-6 -15,-5 -13,-17c11,-62 29,-157 29,-214c0,-170 -130,-200 -197,-200c-151,0 -190,98 -190,163c0,62 40,115 107,115c61,0 96,-47 96,-102c0,-58 -36,-85 -67,-94c-23,-7 -32,-10 -32,-17c0,-13 26,-29 80,-29c59,0 159,18 159,166c0,47 -15,134 -27,201c-2,12 -4,11 -15,9c-20,-4 -46,-6 -69,-6zM80,20c0,-139 113,-236 288,-236c20,0 40,2 56,5c15,3 16,3 14,14l-50,298c-2,11 -4,12 -20,8c-61,-17 -100,-60 -100,-117c0,-46 30,-89 72,-107c7,-3 15,-6 15,-13c0,-6 -4,-11 -12,-11c-7,0 -19,3 -27,6c-68,23 -115,87 -115,177c0,85 57,164 145,194c18,6 18,5 15,24l-21,128c-2,11 -4,12 -14,4c-47,-38 -93,-75 -153,-142c-83,-94 -93,-173 -93,-232zM470,943c-61,0 -133,-96 -133,-252c0,-32 2,-66 6,-92c2,-13 6,-14 13,-8c79,69 174,159 174,270c0,55 -27,82 -60,82zM441,117c-12,1 -13,-2 -11,-14l49,-285c2,-12 4,-12 16,-6c56,28 94,79 94,142c0,88 -67,156 -148,163z"),bbox:{ne:{x:2.684,y:4.392},sw:{x:0,y:-2.632}}},st={path2d:new Path2D("M216 125c93 0 206 -52 206 -123c0 -70 -52 -127 -216 -127c-149 0 -206 60 -206 127c0 68 83 123 216 123zM111 63c-2 -8 -3 -16 -3 -24c0 -32 15 -66 35 -89c21 -28 58 -52 94 -52c10 0 21 1 31 4c33 8 46 36 46 67c0 60 -55 134 -124 134c-31 0 -68 -5 -79 -40z"),bbox:{ne:{x:1.688,y:.5},sw:{x:0,y:-.5}}},at={path2d:new Path2D("M97 -125c-55 0 -97 30 -97 83c0 52 47 167 196 167c58 0 99 -32 99 -83c0 -33 -33 -167 -198 -167zM75 -87c48 0 189 88 189 131c0 7 -3 13 -6 19c-7 12 -18 21 -37 21c-47 0 -192 -79 -192 -128c0 -7 3 -14 6 -20c7 -12 19 -23 40 -23z"),bbox:{ne:{x:1.18,y:.5},sw:{x:0,y:-.5}}},ct={path2d:new Path2D("M0 -42c0 86 88 167 198 167c57 0 97 -32 97 -83c0 -85 -109 -167 -198 -167c-54 0 -97 31 -97 83z"),bbox:{ne:{x:1.18,y:.5},sw:{x:0,y:-.5}}},rt={path2d:new Path2D("M238 -790c-5 -17 -22 -23 -28 -19s-16 13 -16 29c0 4 1 9 3 15c17 45 24 92 24 137c0 59 -9 116 -24 150c-36 85 -131 221 -197 233v239c0 12 8 15 19 15c10 0 18 -6 21 -22c16 -96 58 -182 109 -261c63 -100 115 -218 115 -343c0 -78 -26 -173 -26 -173z"),stemUpNW:{x:0,y:-.04},bbox:{ne:{x:1.056,y:.03521239682756091},sw:{x:0,y:-3.240768470618394}}},lt={path2d:new Path2D("M240 760c-10 29 7 48 22 48c7 0 13 -4 16 -15c8 -32 28 -103 28 -181c0 -125 -61 -244 -124 -343c-51 -79 -125 -166 -142 -261c-2 -16 -15 -22 -24 -22c-8 0 -16 5 -16 15v235c134 45 184 126 221 210c15 34 40 118 40 177c0 45 -7 95 -21 137z"),stemDownSW:{x:0,y:.132},bbox:{ne:{x:1.224,y:3.232896633157715},sw:{x:0,y:-.0575672}}},pt={path2d:new Path2D("M272 -796c-6 -13 -13 -17 -20 -17c-14 0 -22 13 -22 26c0 3 0 5 1 9c5 30 8 60 8 89c0 52 -9 101 -32 149c-69 140 -140 142 -202 144h-5v388c0 7 11 10 17 10s18 -2 20 -13c17 -106 73 -122 127 -180c72 -78 98 -106 108 -174c2 -12 3 -23 3 -36 c0 -61 -22 -121 -25 -127c-1 -3 -1 -5 -1 -7c0 -4 1 -6 1 -9c18 -37 29 -78 29 -120v-22c0 -48 -3 -105 -7 -110zM209 -459c2 -3 4 -4 7 -4c5 0 12 3 13 6c5 8 5 18 7 26c1 7 1 13 1 20c0 32 -9 63 -27 89c-33 49 -87 105 -148 105h-8c-8 0 -14 -6 -14 -10c0 -1 0 -2 1 -3 c21 -82 67 -106 114 -160c21 -24 38 -44 54 -69z"),stemUpNW:{x:0,y:-.088},bbox:{ne:{x:1.116,y:.008},sw:{x:0,y:-3.252}}},dt={path2d:new Path2D("M240 786c-3 17 5 25 17 26c12 0 19 1 24 -22c16 -80 15 -178 -21 -253c0 -3 -1 -5 -1 -9c0 -3 0 -5 1 -7c3 -6 25 -66 25 -127c0 -13 -1 -25 -3 -36c-24 -157 -221 -200 -245 -354c-2 -11 -13 -13 -20 -13c-10 0 -17 5 -17 10v387h5c62 2 143 5 212 145 c38 78 38 169 23 253zM226 456c-3 0 -5 -1 -7 -4c-16 -26 -33 -46 -54 -69c-47 -55 -103 -78 -124 -160c-1 -1 -1 -2 -1 -3c0 -5 6 -10 14 -10h8c61 0 125 56 158 105c18 26 27 56 27 89c0 6 0 13 -1 20c-2 8 -2 18 -7 25c-1 4 -8 7 -13 7z"),stemDownSW:{x:0,y:.128},bbox:{ne:{x:1.1635806326044895,y:3.2480256},sw:{x:-19418183745617774e-21,y:-.03601094374150052}}},mt={path2d:new Path2D("M260 -673c0 -9 1 -18 1 -28c0 -43 -4 -89 -7 -95c-7 -11 -14 -16 -20 -16c-2 0 -4 1 -6 2c-7 3 -13 12 -13 24c0 2 1 4 1 7c5 29 8 57 8 85c0 48 -9 93 -31 137c-64 130 -130 132 -188 134h-5v560c0 7 8 12 14 12c10 0 17 -10 18 -19c17 -100 71 -116 121 -170 c67 -73 90 -100 101 -161c2 -9 2 -18 2 -28c0 -39 -11 -80 -20 -106c14 -29 21 -61 21 -93c0 -57 -21 -112 -23 -119c-1 -2 -1 -4 -1 -6c0 -3 0 -5 1 -7c15 -36 24 -74 26 -113zM208 -181c-55 93 -114 117 -169 117c16 -97 65 -114 114 -168c23 -25 41 -44 55 -62 c5 17 10 34 12 44c1 7 3 13 3 21c0 13 -4 28 -15 48zM219 -456c1 8 2 16 2 24c0 81 -90 177 -170 177c-9 0 -14 -9 -12 -16c22 -73 63 -95 106 -146l5 -5c17 -20 31 -37 46 -59c1 -3 4 -4 7 -4c5 0 10 3 11 6c3 7 3 15 5 23z"),stemUpNW:{x:0,y:.376},bbox:{ne:{x:1.044,y:.596},sw:{x:0,y:-3.248}}},ht={path2d:new Path2D("M273 676v-11c-4 -64 -9 -75 -22 -100l-4 -7c-2 -3 -3 -5 -3 -9l3 -5v-2c4 -10 20 -53 20 -105c0 -34 -7 -72 -23 -101c9 -27 22 -71 22 -114c0 -10 0 -20 -2 -29c-11 -64 -35 -92 -105 -168c-52 -57 -109 -73 -126 -177c-1 -9 -9 -20 -19 -20c-8 0 -14 4 -14 13v589 c61 2 125 4 201 140c23 41 31 70 31 98c0 34 -12 65 -20 110c0 3 -1 5 -1 7c0 13 7 23 14 26c2 1 4 1 6 1c35 0 42 -116 42 -136zM39 268c0 -5 4 -13 13 -13h5c81 0 173 103 173 185c0 8 -1 17 -2 25c-2 8 -2 16 -5 23c-1 3 -7 6 -12 6c-3 0 -6 -1 -8 -4 c-16 -25 -32 -44 -52 -67c-45 -53 -91 -75 -112 -155zM229 243c-3 11 -8 32 -14 51c-14 -18 -32 -38 -56 -64c-52 -57 -103 -73 -120 -177c0 -1 0 -2 2 -3c57 0 118 26 175 122c12 21 16 37 16 50c0 8 -2 14 -3 21z"),stemDownSW:{x:0,y:-.448},bbox:{ne:{x:1.092,y:3.248},sw:{x:0,y:-.687477099907407}}},ut={path2d:new Path2D("M282 -109c0 -14 -12 -26 -26 -26h-230c-15 0 -26 12 -26 26v92c0 15 11 26 26 26h230c14 0 26 -11 26 -26v-92z"),originUnits:1,bbox:{ne:{x:1.128,y:.036},sw:{x:0,y:-.54}}},ft={path2d:new Path2D("M282 24c0 -14 -12 -26 -26 -26h-230c-15 0 -26 12 -26 26v92c0 15 11 26 26 26h230c14 0 26 -11 26 -26v-92z"),originUnits:2,bbox:{ne:{x:1.128,y:.568},sw:{x:0,y:-.008}}},bt={path2d:new Path2D("M78 -38l-49 60s-10 10 -10 24c0 8 4 19 14 29c45 47 60 90 60 127c0 72 -57 123 -61 134c-3 6 -4 11 -4 16c0 14 10 21 20 21c6 0 13 -3 18 -8c17 -17 165 -193 165 -193s4 -9 4 -19c0 -5 -1 -10 -4 -15c-26 -41 -62 -89 -66 -147v-3l-1 -7v-3c0 -56 31 -93 69 -139 c11 -12 37 -45 37 -57c0 -3 -2 -4 -5 -4c-2 0 -4 0 -8 1l-1 1c-17 6 -50 17 -79 17c-42 0 -63 -32 -63 -73c0 -9 1 -18 4 -26c2 -9 13 -36 26 -36c8 -7 16 -15 16 -24c0 -2 -1 -4 -2 -7c-1 -4 -8 -6 -15 -6c-8 0 -18 3 -26 9c-73 56 -116 105 -116 155c0 49 34 96 86 96 l8 -3h4c4 -1 12 -3 16 -3c5 0 9 1 11 5c1 1 1 3 1 4c0 2 -4 10 -6 14c-13 21 -27 40 -43 60z"),originUnits:2,bbox:{ne:{x:1.08,y:1.492},sw:{x:.004,y:-1.5}}},gt={path2d:new Path2D("M134 107v-10c33 0 83 60 90 66c6 4 9 4 11 4c2 -1 12 -6 12 -16c-1 -5 -6 -21 -10 -39c0 0 -98 -351 -101 -353c-10 -8 -24 -10 -35 -10c-6 0 -29 1 -29 13c18 66 90 265 93 280c1 4 1 8 1 11c0 5 -1 9 -5 9c-1 0 -3 0 -5 -1c-13 -7 -22 -11 -36 -15 c-11 -4 -25 -7 -39 -7c-19 0 -38 6 -54 17c-15 12 -27 30 -27 51c0 37 30 67 67 67s67 -30 67 -67z"),originUnits:2,bbox:{ne:{x:.988,y:.696},sw:{x:0,y:-1.004}}},yt={path2d:new Path2D("M208 111v-10c34 1 84 61 91 67c3 2 6 4 11 4c2 -1 10 -5 10 -11c0 -1 -1 -2 -1 -4c-2 -13 -27 -101 -27 -101s-19 -67 -45 -152l-116 -381c-4 -11 -9 -23 -38 -23c-22 0 -31 10 -31 19l1 1v1l95 283v1l1 1c0 4 -2 6 -4 6c-23 -12 -49 -21 -75 -21c-38 0 -80 27 -80 68 c0 38 30 68 68 68c37 0 68 -30 68 -68c0 -3 0 -6 -1 -10c14 0 41 12 49 31c7 15 58 164 58 180c0 5 -2 7 -5 7c-2 0 -4 -1 -7 -2c-23 -13 -51 -22 -78 -22c-38 0 -80 27 -80 68c0 38 31 68 68 68c38 0 68 -30 68 -68z"),originUnits:2,bbox:{ne:{x:1.28,y:.716},sw:{x:0,y:-2}}},xt={path2d:new Path2D("M353 419c2 0 10 -2 10 -11c0 -1 -1 -2 -1 -4c-2 -12 -26 -101 -26 -101s-172 -770 -175 -782c-4 -11 -7 -21 -39 -21c-21 0 -27 8 -27 16c0 2 0 4 1 6c2 7 71 282 71 286c0 3 -3 6 -6 6c-1 0 -2 0 -3 -1c-23 -13 -51 -22 -78 -22c-38 0 -80 27 -80 68c0 38 31 68 68 68 c38 0 68 -30 68 -68c0 -3 0 -6 -1 -10c15 1 46 14 51 35l40 164c0 5 -2 13 -7 13c-1 0 -2 0 -3 -1c-23 -12 -49 -22 -75 -22c-10 0 -19 2 -27 4c-10 3 -19 7 -27 14c-16 12 -28 30 -28 50c0 38 30 68 68 68c37 0 68 -30 68 -68c0 -3 0 -6 -1 -9c16 0 49 20 54 36l39 160v1 l1 2c0 7 -4 17 -11 17c-1 0 -3 0 -4 -1c-23 -12 -50 -22 -76 -22c-10 0 -18 2 -26 4c-10 3 -20 7 -28 14c-16 12 -28 30 -28 50c0 38 31 68 68 68c38 0 68 -30 68 -68v-9c34 0 84 61 91 66c3 2 6 4 11 4z"),originUnits:2,bbox:{ne:{x:1.452,y:1.704},sw:{x:0,y:-2}}},vt={path2d:new Path2D("M12 -170c-8 10 -12 581 -12 581c1 18 17 28 31 28c10 0 19 -6 19 -17c0 -20 -6 -260 -7 -282c0 -7 4 -14 11 -17c2 -1 3 -1 5 -1c5 0 16 9 22 14c14 9 38 17 55 17c46 -3 90 -39 90 -96c0 -46 -31 -107 -120 -169c-25 -17 -49 -44 -79 -61c0 0 -3 -2 -6 -2s-6 1 -9 5z M47 -81c0 -5 2 -15 11 -15c3 0 6 1 10 3c43 27 89 81 89 135c0 25 -12 58 -41 58c-23 0 -63 -29 -70 -49c-1 -4 -2 -16 -2 -32c0 -40 3 -100 3 -100z"),bbox:{ne:{x:.904,y:1.756},sw:{x:0,y:-.7}}},Pt={path2d:new Path2D("M141 181l15 5c1 1 3 1 4 1c4 0 8 -3 8 -8v-502c0 -7 -6 -12 -12 -12h-13c-7 0 -12 5 -12 12v149c0 8 -7 11 -17 11c-29 0 -85 -24 -99 -30c-1 -1 -3 -1 -4 -1l-2 -1c-6 0 -9 3 -9 9v515c0 7 5 12 12 12h13c6 0 12 -5 12 -12v-167c0 -4 4 -5 10 -5c26 0 90 23 90 23 c1 0 2 1 4 1zM37 39v-103c0 -4 5 -6 12 -6c25 0 82 23 82 41v103c0 4 -3 5 -9 5c-24 0 -85 -26 -85 -40z"),bbox:{ne:{x:.672,y:1.364},sw:{x:0,y:-1.34}}},wt={path2d:new Path2D("M237 118l-26 -10c-8 -3 -13 -22 -13 -29v-93c0 -12 7 -18 13 -18l26 10c2 1 3 1 5 1c4 0 7 -3 7 -8v-71c0 -6 -5 -14 -12 -17c0 0 -21 -8 -28 -11s-11 -15 -11 -23v-142c0 -6 -6 -11 -17 -11c-7 0 -13 5 -13 11v125c0 6 -5 18 -14 18l-2 -1h-1l-61 -25 c-5 -2 -10 -9 -10 -22v-139c0 -6 -7 -11 -17 -11c-7 0 -13 5 -13 11v123c0 5 -5 16 -12 16c-1 0 -2 0 -3 -1c-9 -3 -23 -9 -24 -9l-2 -1c-6 0 -9 3 -9 9v71c0 6 5 14 12 16c0 0 21 9 27 11c6 3 11 12 11 23v99c0 8 -6 18 -14 18l-1 -1c-8 -4 -23 -10 -24 -10l-2 -1 c-6 0 -9 3 -9 9v71c0 6 5 14 12 16c0 0 20 8 26 11s12 13 12 27v135c0 6 6 11 16 11c7 0 14 -5 14 -11v-120c0 -8 3 -20 12 -20c17 4 51 18 63 25c9 6 12 19 13 29v130c0 6 6 11 16 11c8 0 14 -5 14 -11v-122c0 -8 7 -13 14 -13c5 1 25 9 25 9c2 1 3 1 5 1c4 0 7 -3 7 -8 v-71c0 -6 -5 -14 -12 -17zM168 -45c2 9 4 37 4 64s-2 52 -4 57c-2 4 -8 6 -15 6c-25 0 -71 -21 -73 -38c-2 -8 -3 -43 -3 -74c0 -24 1 -46 3 -50c1 -3 6 -5 12 -5c23 0 70 20 76 40z"),bbox:{ne:{x:.996,y:1.4},sw:{x:0,y:-1.392}}};var Mt=(e,t)=>Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2)),Ct=(e,t)=>({x:e.x*t,y:e.y*t});var N=(e,t)=>{let n=typeof t?.x=="number"?t.x:0,o=typeof t?.y=="number"?t.y:0;return{left:e.left+n,top:e.top+o,right:e.right+n,bottom:e.bottom+o}},R=(e,t)=>({left:e.bbox.sw.x*t,top:-e.bbox.ne.y*t,bottom:-e.bbox.sw.y*t,right:e.bbox.ne.x*t}),Et=({x:e,y:t},{left:n,top:o,right:i,bottom:s})=>n<=e&&e<=i&&o<=t&&t<=s;var ae=new Map([[8,rt],[16,pt],[32,mt]]),ce=new Map([[8,lt],[16,dt],[32,ht]]),re=new Map([[1,ut],[2,ft],[4,bt],[8,gt],[16,yt],[32,xt]]),le=new Map([["sharp",wt],["natural",Pt],["flat",vt]]),Bt=new Map([[8,1],[16,2],[32,3]]),j=e=>{switch(e){case 1:return st;case 2:return at;default:return ct}},St=e=>e===1?Qe:Je;var Dt=50,un=.08,W=()=>un,fn=.08,T=()=>fn,bn={x:250,y:2e3},U=()=>bn,gn=300,z=()=>gn,yn=400,_=()=>yn;var G="#FF0000",kt=(e,t)=>({x:e.x+(t.right-t.left)/2,y:e.y+(t.bottom-t.top)}),Ot=({note:e,stemDirection:t,beamed:n=!1,pointing:o})=>{let i=[],s=[],a=[];for(let m of e.pitches){if(!m.accidental)continue;let{pitch:f,accidental:H}=m,hn=E(0,f,1);a.push(R(le.get(H),b)),i.push({type:"accidental",position:{x:0,y:hn},accidental:H})}s.push(...a);let c=0;a.length>0&&(c=a[0].right+Lt(1));let p=e.pitches.map(m=>m.pitch),r=Math.min(...p),l=Math.max(...p),d=xn(e.duration),h=[];if(r<=0)for(let m=0;m>=r;m-=2){let f=E(0,m,1);i.push({type:"ledger",width:d,position:{x:c,y:f}}),h.push({left:c,right:c+d,top:f-A,bottom:f+A})}if(l>=12)for(let m=12;m<l+1;m+=2){let f=E(0,m,1);i.push({type:"ledger",width:d,position:{x:c,y:f}}),h.push({left:c,right:c+d,top:f-A,bottom:f+A})}s.push(...h);let u=0;h.length>0?u=h[0].left+Tt(1):a.length>0&&(u=a[0]?.right+Lt(1)*2),t||(t=It(p));let g=[],w=[],P=Rt(e.pitches,"asc");if(t==="up")for(let m=0;m<P.length;m++)m===0?g.push(P[m]):P[m].pitch-P[m-1].pitch==1?(w.push(P[m]),m+1<P.length&&g.push(P[++m])):g.push(P[m]);else{let m=P.concat().reverse();for(let f=0;f<m.length;f++)f===0?w.push(m[f]):m[f-1].pitch-m[f].pitch==1?(g.push(m[f]),f+1<m.length&&w.push(m[++f])):w.push(m[f])}let v=[];for(let m of g){let f={x:u,y:E(0,m.pitch,1)},H=N(R(j(e.duration),b),f);i.push({type:"head",position:f,duration:e.duration,tie:kt(f,H)}),v.push(H)}let y=u;if(g.length>0&&(y=v[0].right),s.push(...v),!n){let{elements:m,bboxes:f}=Ht({left:y,duration:e.duration,direction:t,lowest:P[0],highest:P[P.length-1]});i.push(...m),s.push(...f)}for(let m of w){let f={x:u,y:E(0,m.pitch,1)},H=N(R(j(e.duration),b),f);i.push({type:"head",position:f,duration:e.duration,tie:kt(f,H)}),s.push(H)}console.log("note bboxes",s);let S=Nt(s);return{element:{type:"note",note:e,elements:i,...o?{color:G}:void 0},width:S.right-S.left,stemOffsetLeft:y,bbox:S}},Nt=e=>{let t;for(let n of e)t?(n.left<t.left&&(t.left=n.left),n.top<t.top&&(t.top=n.top),n.right>t.right&&(t.right=n.right),n.bottom>t.bottom&&(t.bottom=n.bottom)):t=n;return t},Tt=e=>b*Ze*e,xn=e=>St(e)+Tt(1)*2,It=e=>{let t=6-Math.min(...e),n=Math.max(...e)-6;return t>n?"up":n>t?"down":vn(e)<6?"up":"down"},vn=e=>{let t=e.reduce((n,o)=>n+o)/e.length;return Math.round(t)},Me=({dnp:e,direction:t,lowest:n,highest:o,extension:i=0})=>{let{topOfStaff:s,scale:a,duration:c}=e,p=s+C*a/2,r,l;if(t==="up"){if(l=E(s,n.pitch,a)-5,o.pitch<0)r=p;else{let d=c<32?o.pitch+7:o.pitch+8;r=E(s,d,a)}r-=i}else{if(r=E(s,o.pitch,a),n.pitch>12)l=p;else{let d=c<32?n.pitch-7:n.pitch-8;l=E(s,d,a)}l+=i}return{top:r,bottom:l}},Lt=e=>b/4*e,Ht=({left:e,duration:t,direction:n,lowest:o,highest:i,beamed:s})=>{if(t===1)return{elements:[],bboxes:[]};let a=[],{top:c,bottom:p}=Me({dnp:{topOfStaff:0,scale:1,duration:t},direction:n,lowest:o,highest:i}),r,l=[];if(n==="up")if(r=e-F/2,s)c=s.top;else{let h=ae.get(t),u=r-F/2;if(h){let g={x:u+b*h.stemUpNW.x,y:c+b*h.stemUpNW.y};a.push({type:"flag",position:g,duration:t,direction:n}),l.push(N(R(h,b),g))}}else if(r=e+F/2,s)p=s.bottom;else{let h=ce.get(t);if(h){let u={x:r-F/2+b*h.stemDownSW.x,y:p+b*h.stemDownSW.y};a.push({type:"flag",position:u,duration:t,direction:n}),l.push(N(R(h,b),u))}}let d={type:"stem",position:{x:r-F/2,y:c},width:F,height:p-c};return a.push(d),l.push({left:d.position.x,top:d.position.y,right:d.position.x+d.width,bottom:d.position.y+d.height}),{elements:a,bboxes:l}},Pn=(e,t)=>{let n=re.get(e.duration),o=b*n.originUnits,i={x:0,y:o},s=N(R(n,b),{y:o});return{element:{type:"rest",rest:e,position:i,...t?{color:G}:{}},bbox:s,width:s.right-s.left}},wn=(e,t)=>{let n=tt*b,o=et*b;if(e.subtype==="single")return{element:{type:"bar",bar:e,...t?{color:G}:{},elements:[{type:"line",position:{x:0,y:0},height:C,lineWidth:n}]},width:n,bbox:{left:0,top:0,right:n,bottom:C}};if(e.subtype==="double")return{element:{type:"bar",bar:e,...t?{color:G}:{},elements:[{type:"line",position:{x:0,y:0},height:C,lineWidth:n},{type:"line",position:{x:n+o,y:0},height:C,lineWidth:n}]},width:o+n*2,bbox:{left:0,top:0,right:o+n*2,bottom:C}};{let i=nt*b,s=ot*b,a=X*2+s+n+o+i;return{element:{type:"bar",bar:e,...t?{color:G}:{},elements:[{type:"dot",position:{x:0,y:b+b/2}},{type:"line",position:{x:X*2+s,y:0},height:C,lineWidth:n},{type:"line",position:{x:X*2+s+n+o,y:0},height:C,lineWidth:i}]},width:a,bbox:{left:0,top:0,right:a,bottom:C}}}},E=(e,t,n)=>{let o=C*n/8;return e+b*4.5*n+o-t*o},Mn=({dnp:e,stemDirection:t,beamed:n,arr:o})=>{let i=n[0],s=n[n.length-1],a=b/2*3*e.scale,c=o[o.length-1].left+o[o.length-1].stemOffsetLeft-(o[0].left+o[0].stemOffsetLeft),p,r;if(t==="up"){if(n.length===1)p=0;else{let v=i.pitches[i.pitches.length-1].pitch,y=s.pitches[s.pitches.length-1].pitch,S=E(e.topOfStaff,v,e.scale),f=E(e.topOfStaff,y,e.scale)-S;v>y?p=(f>=a?a:f)/c:p=(-f>=a?-a:f)/c}let g=n.map((v,y)=>({note:v,leftOfStem:o[y].left+o[y].stemOffsetLeft})).sort((v,y)=>y.note.pitches[y.note.pitches.length-1].pitch-v.note.pitches[v.note.pitches.length-1].pitch)[0],w=g.leftOfStem,P=Me({dnp:e,direction:t,lowest:{pitch:g.note.pitches[0].pitch},highest:{pitch:g.note.pitches[g.note.pitches.length-1].pitch}}).top;r={x:w,y:P}}else{if(n.length===1)p=0;else{let v=i.pitches[0].pitch,y=s.pitches[0].pitch,S=E(e.topOfStaff,v,e.scale),f=E(e.topOfStaff,y,e.scale)-S;v>y?p=(f>=a?a:f)/c:p=(-f>=a?-a:f)/c}let g=n.map((v,y)=>({note:v,leftOfStem:o[y].left+o[y].stemOffsetLeft})).sort((v,y)=>v.note.pitches[0].pitch-y.note.pitches[0].pitch)[0],w=g.leftOfStem,P=Me({dnp:e,direction:t,lowest:{pitch:g.note.pitches[0].pitch},highest:{pitch:g.note.pitches[g.note.pitches.length-1].pitch}}).bottom;r={x:w,y:P}}let{x:l,y:d}=r,h=-l*p+d;return u=>u*p+h},Cn=({scale:e,stemDirection:t,beamLeft:n,beamRight:o,stemLinearFunc:i,offsetY:s=0})=>{let a=b*we*e,c=i(n)+(t==="up"?s:-s),p={x:n,y:t==="up"?c:c-a},r={x:n,y:t==="up"?c+a:c},l=i(o)+(t==="up"?s:-s),d={x:o,y:t==="up"?l:l-a},h={x:o,y:t==="up"?l+a:l};return{nw:p,ne:d,se:h,sw:r}},Rt=(e,t)=>{let n=(o,i)=>t==="asc"?o.pitch<i.pitch:i.pitch<o.pitch;return e.sort((o,i)=>n(o,i)?-1:o.pitch===i.pitch?0:1)},At=e=>{let{beamedNotes:t,notePositions:n,linearFunc:o,stemDirection:i,duration:s=8,headOrTail:a}=e;console.log("determineBeamStyle",s);let c=!1,{beam:p}=t[t.length-1];(p==="continue"||p==="begin")&&(s>8?c=a==="tail":c=!0);let r=n[0].left+n[0].stemOffsetLeft,l=n[n.length-1].left+n[n.length-1].stemOffsetLeft+(c?b:0);s>8&&t.length===1&&(a==="head"?l=r+b:a==="tail"&&(r=l-b));let d=[],h=(b*we+b*it)*(Bt.get(s)-1),u=Cn({scale:1,stemDirection:i,beamLeft:r,beamRight:l,stemLinearFunc:o,offsetY:h});if(d.push({element:{type:"beam",...u},width:l-r,bbox:{left:u.sw.x,top:u.ne.y,right:u.ne.x,bottom:u.sw.y}}),s===32)return d;let g=s*2,w=[],P=0,v=0,y;for(;v<t.length;){if(t[v].duration>=g){if(!y){let m;v===0?m="head":v===t.length-1&&(m="tail"),y={start:v,end:v,headOrTail:m},w.push(y)}}else y&&(w[P].end=v,P++,y=void 0);v++}y&&(w[P].end=t.length,w[P].headOrTail="tail"),console.log(w);for(let{start:S,end:m,headOrTail:f}of w)d.push(...At({...e,beamedNotes:t.slice(S,m),notePositions:n.slice(S,m),duration:g,headOrTail:f}));return d},En=(e,t,n,o,i)=>{let s=e.flatMap(h=>h.pitches).map(h=>h.pitch),a=It(s),c=[],p=[],r=0;for(let h in e){let u=Number(h),g=i?.type==="note"&&i.index===u+o?i:void 0,w=Ot({note:e[u],stemDirection:a,beamed:!0,pointing:g});c.push({left:r,stemOffsetLeft:w.stemOffsetLeft});let P={index:u+o};p.push({caretOption:P,index:u+o,...w}),r+=w.width,p.push(Ft({width:n,height:C,caretOption:{...P,index:u+o,defaultWidth:!0}})),r+=n}let l=Mn({dnp:{topOfStaff:0,scale:1,duration:t},stemDirection:a,beamed:e,arr:c}),d=At({beamedNotes:e,notePositions:c,linearFunc:l,stemDirection:a});for(let h in e){let{pitches:u}=e[h],g=Rt(u,"asc"),w=l(c[h].left+c[h].stemOffsetLeft),P;a==="up"?P={top:w}:P={bottom:w};let v=Ht({left:c[h].stemOffsetLeft,duration:t,direction:a,lowest:g[0],highest:g[g.length-1],beamed:P}),y=p[Number(h)*2],S=y.element;y.bbox=Nt([y.bbox,...v.bboxes]),S.elements.push(...v.elements)}return[...d,...p]},Bn=(e,t)=>{let n=e.element.elements.find(o=>o.type==="head");return{element:{type:"tie",position:{...n.tie,y:n.tie.y-70},cpLow:{x:t/2,y:120},cpHigh:{x:t/2,y:180},end:{x:t,y:0}},width:t,bbox:{left:0,top:0,right:0,bottom:0}}},Ft=({width:e,height:t,caretOption:n})=>({element:{type:"gap"},width:e,bbox:{left:0,top:0,right:e,bottom:t},caretOption:n}),Sn=(e,t,n)=>{let o=R(se,b),i=E(0,4,1);return{element:{type:"clef",clef:e,...n?{color:G}:{}},width:o.right-o.left,bbox:N(o,{y:i}),index:t}},pe=(e,t,n,o)=>{let i=[],s=Ft({width:t,height:C}),a=0;if(console.log("left",a),n&&(i.push(s),a+=t,console.log("left",a),n.clef)){let r=o?.index===-1?o:void 0,l=Sn(n.clef,-1,r);i.push(l),a+=l.width,console.log("left",a)}i.push({...s,caretOption:{index:-1,defaultWidth:!0}}),a+=t,console.log("left",a);let c=0;for(;c<e.length;){let r=e[c];if(r.type==="note")if(r.beam==="begin"){let l=[r],d=o?.index===c?o:void 0,h=c+1,u=e[h];for(;u?.type==="note"&&(u.beam==="continue"||u.beam==="end");)d||(d=o?.index===h?o:void 0),l.push(u),u=e[++h];let g=En(l,r.duration,t,c,d);i.push(...g),c+=l.length}else{let l=o?.index===c?o:void 0,d=Ot({note:r,pointing:l});i.push({caretOption:{index:c},index:c,...d}),a+=d.width,i.push({...s,caretOption:{index:c,defaultWidth:!0}}),a+=t,c++}else if(r.type==="rest"){let l=o?.index===c?o:void 0,d=Pn(r,l);i.push({caretOption:{index:c},index:c,...d}),a+=d.width,i.push({...s,caretOption:{index:c,defaultWidth:!0}}),a+=t,c++}else if(r.type==="bar"){let l=o?.index===c?o:void 0,d=wn(r,l);i.push({caretOption:{index:c},index:c,...d}),a+=d.width,i.push({...s,caretOption:{index:c,defaultWidth:!0}}),a+=t,c++}}let p=[];for(let r in i){let l=Number(r),d=i[l];if(d.element.type==="note"&&d.element.note.tie==="start"){let h=d.width;for(let u=l+1;u<i.length;u++){let g=i[u];g.element.type==="note"&&g.element.note.tie==="stop"?(p.push({index:l,style:Bn(d,h)}),h=0):h+=g.width}}}for(let{index:r,style:l}of p)i.splice(r,0,l);return i},Wt=(e,t,n)=>{let{index:o,defaultWidth:i}=e,s=i?Dt:t;return{x:n+(i?t/2-s/2:0),y:0,width:s,elIdx:o}};var J=({leftPx:e,topPx:t,width:n,height:o,_canvas:i})=>{let s=i??document.createElement("canvas");s.style.position="absolute",s.style.top=`${t}px`,s.style.left=`${e}px`,s.style.width=`${n}px`,s.style.height=`${o}px`,s.width=n,s.height=o,s.getContext("2d")},Q=(e,t,n,o,i,s)=>{e.save(),e.rotate(Math.PI/180*180),e.translate(-t,-n),e.scale(-o,o),e.fillStyle=s||"#000",e.fill(i.path2d),e.restore()},Dn=(e,t,n,o)=>{let i=E(o,4,1);Q(e,n,i,1,se,t.color)},de=(e,t,n,o,i)=>{let s=b*i;for(let a=0;a<5;a++){let c=n+s*a;e.save(),e.strokeStyle="#000",e.lineWidth=je*i,e.beginPath(),e.moveTo(t,c),e.lineTo(t+o,c),e.closePath(),e.stroke(),e.restore()}},kn=(e,t)=>{let n=t.color??"#000";for(let o of t.elements){if(e.save(),o.type==="line")e.translate(o.position.x+o.lineWidth/2,o.position.y),e.strokeStyle=n,e.lineWidth=o.lineWidth,e.beginPath(),e.moveTo(0,0),e.lineTo(0,o.height),e.closePath(),e.stroke();else{let i=X;e.translate(o.position.x+i,o.position.y),e.fillStyle=n,e.beginPath(),e.arc(0,0,i,0,Math.PI*2),e.fill(),e.beginPath(),e.arc(0,b,i,0,Math.PI*2),e.fill()}e.restore()}},Nn=({ctx:e,element:t})=>{let n=t.color??"#000";for(let o of t.elements)if(o.type==="head"){let{duration:i,position:s}=o;e.save(),e.translate(s.x,s.y);let a=j(i);Q(e,0,0,1,a,n),e.restore()}else if(o.type==="ledger"){let{width:i,position:s}=o;e.save(),e.translate(s.x,s.y),e.strokeStyle=n,e.lineWidth=A,e.beginPath(),e.moveTo(0,0),e.lineTo(i,0),e.closePath(),e.stroke(),e.restore()}else if(o.type==="accidental"){let{position:i,accidental:s}=o,a=le.get(s);e.save(),e.translate(i.x,i.y),Q(e,0,0,1,a,n),e.restore()}else if(o.type==="flag"){let{duration:i,direction:s,position:a}=o,c=s==="up"?ae.get(i):ce.get(i);c&&Q(e,a.x,a.y,1,c,n)}else if(o.type==="stem"){let{position:i,width:s,height:a}=o;e.save(),e.translate(i.x+s/2,i.y),e.strokeStyle=n,e.lineWidth=s,e.beginPath(),e.moveTo(0,0),e.lineTo(0,a),e.stroke(),e.restore()}},Tn=({ctx:e,element:t})=>{let{rest:n,position:o,color:i}=t,s=re.get(n.duration);e.save(),e.translate(o.x,o.y),Q(e,0,0,1,s,i),e.restore()},In=(e,t)=>{e.save(),e.fillStyle="#000",e.beginPath(),e.moveTo(t.nw.x,t.nw.y),e.lineTo(t.sw.x,t.sw.y),e.lineTo(t.se.x,t.se.y),e.lineTo(t.ne.x,t.ne.y),e.closePath(),e.fill(),e.restore()},Ln=(e,t)=>{e.save(),e.fillStyle="#000",e.translate(t.position.x,t.position.y),e.moveTo(0,0),e.quadraticCurveTo(t.cpLow.x,t.cpLow.y,t.end.x,t.end.y),e.quadraticCurveTo(t.cpHigh.x,t.cpHigh.y,0,0),e.closePath(),e.fill(),e.restore()},me=(e,{element:t})=>{let{type:n}=t;n==="clef"?Dn(e,t,0,0):n==="note"?Nn({ctx:e,element:t}):n==="rest"?Tn({ctx:e,element:t}):n==="beam"?In(e,t):n==="tie"?Ln(e,t):n==="bar"&&kn(e,t)};var Ut=({ctx:e,scale:t,caret:n})=>{let{x:o,y:i,width:s}=n,a=C*t;e.save(),e.fillStyle="#FF000055",e.fillRect(o,i,s,a),e.restore()},he=({ctx:e,width:t,height:n,fillStyle:o})=>{e.save(),e.fillStyle=o,e.fillRect(0,0,t,n),e.restore()};var zt=["sharp","natural","flat"];var Ce=[void 0,...zt];var _t=[{type:"note",duration:4,pitches:[{pitch:1}],tie:"start"},{type:"note",duration:4,pitches:[{pitch:1}],tie:"stop"}];function M(){return _t}function ue(e){_t=e}var Ee=!0;function $(){return Ee}function Kt(){Ee=!Ee}var Xt="nobeam",O=()=>Xt,Gt=e=>{Xt=e},$t,q=()=>$t,qt=e=>{$t=e},fe=0,V=()=>Ce[fe],Vt=()=>{fe=fe===Ce.length-1?0:fe+1},Yt,I=()=>Yt,be=e=>{Yt=e},jt=[],Z=()=>jt,Jt=e=>{jt=e},Be=[],ge=()=>Be,Qt=e=>{Be.push(e)},Zt=()=>{Be=[]},en,ye=()=>en,tn=e=>{en=e},xe=0;function x(){return xe}function Y(e){xe=e}function ve(e){xe+=e}var ee=[];function nn(){ee=[]}function Pe(){return ee}function on(e){ee.push(e)}var sn=e=>ee[e];function te(){return ee[xe]}var an=!1,cn=()=>an,Se=e=>{an=e},B=()=>{Jt(pe(M(),b,{clef:{type:"g"}},ye())),Hn(),Se(!0)},Hn=()=>{nn(),Zt();let e=0;for(let t of Z()){console.log("style",t);let{width:n,element:o,caretOption:i,bbox:s,index:a}=t;Qt({bbox:N(s,{x:e}),elIdx:a}),i&&on(Wt(i,n,e)),o.type!=="beam"&&o.type!=="tie"&&(e+=n)}},rn=e=>{he({ctx:e,width:window.innerWidth,height:window.innerHeight,fillStyle:"#fff"}),e.save(),e.scale(W(),W()),e.translate(U().x,U().y),de(e,0,0,b*100,1);for(let t of Z())me(e,t),t.element.type!=="beam"&&t.element.type!=="tie"&&e.translate(t.width,0);e.restore(),Rn(e)},Rn=e=>{console.log("carets",Pe()),console.log("current caret",te()),e.save(),e.scale(W(),W()),e.translate(U().x,U().y),Ut({ctx:e,scale:1,caret:te()}),e.restore()};var ne=e=>e.sort((t,n)=>t.pitch===n.pitch?t.accidental===n.accidental||!t.accidental&&n.accidental==="natural"||t.accidental==="natural"&&!n.accidental?0:t.accidental==="flat"&&n.accidental!=="flat"||(t.accidental==="natural"||!t.accidental)&&n.accidental==="sharp"?-1:1:t.pitch<n.pitch?-1:1);function oe({caretIndex:e,elements:t,newElement:n,beamMode:o}){let i=[...t],s=0,a=0;if(e===0){let c=i[e];De(o,n,void 0,c),i.splice(e,0,n),a=2}else if(e%2==0){let c=e/2,p=i[c-1],r=i[c];console.log("insertIdx",c,"left",p,"right",r),De(o,n,p,r),i.splice(c,0,n),a=2,s=c}else{let c=e===1?0:(e-1)/2,p=i[c];n.type==="note"&&p.type==="note"&&n.duration===p.duration&&(n.pitches=ne([...p.pitches,...n.pitches]));let r=i[c-1],l=i[c+1];De(o,n,r,l),i.splice(c,1,n),s=c}return{elements:i,insertedIndex:s,caretAdvance:a}}function De(e,t,n,o){t.type==="note"&&e!=="nobeam"?n?.type==="note"&&o?.type==="note"&&n.beam&&o.beam?n.beam==="begin"?o.beam==="begin"?(t.beam="continue",o.beam="continue"):t.beam="continue":n.beam==="continue"&&(o.beam==="begin"?t.beam="end":t.beam="continue"):(t.beam="begin",n?.type==="note"&&(n?.beam==="begin"||n?.beam==="continue")&&(t.beam="continue"),o?.type==="note"&&o?.beam==="begin"&&(o.beam="continue")):(o?.type==="note"&&(o?.beam==="continue"?o.beam="begin":o?.beam==="end"&&delete o.beam),n?.type==="note"&&(n?.beam==="begin"?delete n.beam:n?.beam==="continue"&&(n.beam="end")))}var ke=class{constructor(){}commit(t){let{elements:n,insertedIndex:o,caretAdvance:i}=oe({caretIndex:x(),elements:M(),newElement:t,beamMode:O()});be(o),ve(i),ue(n),B()}};var Ne=class{constructor(){}onMove(t){let n;for(let o in ge()){let{type:i}=Z()[o].element;if(!(i==="gap"||i==="beam"||i==="tie")&&Et(Ct(t,1/W()),N(ge()[o].bbox,U()))){let{elIdx:s}=ge()[o];s!==void 0&&(n={index:s,type:i})}}ye()!==n&&(tn(n),B())}};var Te=class{constructor(){}getMode(){return V()}next(){Vt()}};function ie(e,t,n){e.type==="note"&&(e.beam==="begin"||e.beam==="continue")&&(!n||n?.type==="note"&&(!n?.beam||n?.beam==="begin"))&&(t?.type==="note"&&(t?.beam==="begin"||t?.beam==="continue")?e.beam="end":delete e.beam)}var Ie=class{constructor(){this.noteKeyEls=Array.from(document.getElementsByClassName("note"))}getMode(){return O()}change(t){this.noteKeyEls.forEach(o=>{o.className=o.className.replace(t==="nobeam"?"beamed":"nobeam",t==="nobeam"?"nobeam":"beamed")}),Gt(t);let n=M()[I()];if(n){let o=M()[I()-1],i=M()[I()+1];ie(n,o,i),B()}}};var Le=class{constructor(){this.noteKeyEls=Array.from(document.getElementsByClassName("note"));this.changeNoteRestKey=document.getElementsByClassName("changeNoteRest")[0]}isNoteInputMode(){return $()}change(){this.noteKeyEls.forEach(t=>{t.className=t.className.replace(this.isNoteInputMode()?"note":"rest",this.isNoteInputMode()?"rest":"note")}),this.changeNoteRestKey.className=this.changeNoteRestKey.className.replace(this.isNoteInputMode()?"rest":"note",this.isNoteInputMode()?"note":"rest"),Kt()}};var He=class{constructor(){}getMode(){return q()}change(t){qt(t)}};var Re=class{constructor(){}back(){if(x()%2!=0){let t=x()===1?0:(x()-1)/2;if(t===I()){let n=M()[I()],o=M()[t-1],i=M()[t+1];ie(n,o,i)}}Y(Math.max(x()-1,0)),B()}forward(){if(x()%2==0){let t=x()/2-1;if(t===I()){let n=M()[I()],o=M()[t-1],i=M()[t+1];ie(n,o,i)}}Y(Math.min(x()+1,Pe().length-1)),B()}};var Oe=class extends Map{constructor(t,n){super(n);this.provider=t}get(t){let n=super.get(t);return n||(n=this.provider(t),super.set(t,n)),n}};var K=class{static getById(t){return this.canvasMap.get(t)}};K.canvasMap=new Oe(t=>On(t));var On=e=>{let t=document.getElementById(e),n=t.getContext("2d");return{canvas:t,ctx:n}};var L,Ae=class{constructor(){let{canvas:t,ctx:n}=K.getById("previewCanvas");this.previewCanvas=t,this.previewCtx=n}startPreview(t,n,o){let i=n-z()/2,s=o-_()/2;J({leftPx:i,topPx:s,width:z(),height:_(),_canvas:this.previewCanvas}),L=[...M()];let a={pitch:Fe(T(),0,6),accidental:V()},c;if(q()&&x()>0&&x()%2==0){let r=L[x()/2-1];r?.type==="note"&&r.pitches[0].pitch===a.pitch&&r.pitches[0].accidental===a.accidental&&(r.tie="start",c="stop")}let p=$()?{type:"note",duration:t,pitches:[a],tie:c}:{type:"rest",duration:t};if(x()>0&&x()%2!=0){let r=x()===1?0:(x()-1)/2,l=L[r];p.type==="note"&&l.type==="note"&&p.duration===l.duration&&(p.pitches=ne([...l.pitches,...p.pitches]))}ln(this.previewCtx,L,O(),p),this.previewCanvas.style.visibility="visible"}updatePreview(t,n){L=[...M()];let o={pitch:Fe(T(),n,6),accidental:V()},i;if(q()&&x()>0&&x()%2==0){let a=L[x()/2-1];a?.type==="note"&&a.pitches[0].pitch===o.pitch&&a.pitches[0].accidental===o.accidental&&(a.tie="start",i="stop")}let s=$()?{type:"note",duration:t,pitches:[o],tie:i}:{type:"rest",duration:t};if(x()>0&&x()%2!=0){let a=x()===1?0:(x()-1)/2,c=L[a];s.type==="note"&&c.type==="note"&&s.duration===c.duration&&(s.pitches=ne([...c.pitches,...s.pitches]))}ln(this.previewCtx,L,O(),s)}commit(t,n){let o,i={pitch:Fe(T(),n??0,6),accidental:V()},s;if(q()&&x()>0&&x()%2==0){let r=M()[x()/2-1];r?.type==="note"&&r.pitches[0].pitch===i.pitch&&r.pitches[0].accidental===i.accidental&&(r.tie="start",s="stop")}$()?o={type:"note",duration:t,pitches:[i],tie:s}:o={type:"rest",duration:t};let{elements:a,insertedIndex:c,caretAdvance:p}=oe({caretIndex:x(),elements:M(),newElement:o,beamMode:O()});be(c),ve(p),ue(a),B(),L=[]}backspace(){let t=te().elIdx;if(t<0)return;let n=M().splice(t,1)[0];if(n.type==="note"){let i=M()[t-1],s=M()[t];n.beam==="begin"&&s?.type==="note"?s.beam="begin":n.beam==="end"&&i?.type==="note"&&(i.beam="end")}let o=x()-1;for(;o>-1;)o===0?(Y(0),o=-1):sn(o).elIdx!==t?(Y(o),o=-1):o--;B()}finish(){this.previewCanvas.style.visibility="hidden"}},Fe=(e,t,n)=>{let o=b/2*e;return Math.round(t/o+n)};var ln=(e,t,n,o)=>{console.log("preview","start"),he({ctx:e,width:z(),height:_(),fillStyle:"#fff"});let{elements:i,insertedIndex:s}=oe({caretIndex:x(),elements:t,newElement:o,beamMode:n});console.log("insertedIdx",s),console.log("preview",i);let a=_()/2-C*T()/2,c=[...pe(i,b)],p=new Map,r=0;for(let d of c){let{width:h,element:u,index:g}=d;console.log("style",d),g!==void 0&&p.set(g,r+h/2),u.type!=="beam"&&u.type!=="tie"&&(r+=h)}console.log("elIdxToX",p),e.save(),e.translate(0,a),e.scale(T(),T()),de(e,0,0,b*100,1),e.restore(),e.save(),e.translate(z()/2,a),e.scale(T(),T());let l=p.get(s);console.log("centerX",l),e.translate(-l,0);for(let d of c){let{width:h,element:u}=d;me(e,d),u.type!=="beam"&&u.type!=="tie"&&e.translate(h,0)}e.restore(),console.log("preview","end")};var pn=class{constructor(t,n){this.targetClassNames=t;this.handlers=n;this.kLongDownThresholdMs=300;this.kDragThresholdMagnitude=10;this.longDownTimer=0;this.isDragging=!1}listener(t){let n=t,{className:o}=n.target;switch(t.type){case"pointerdown":if(this.targetClassNames.length>0&&!this.targetClassNames.some(i=>o.includes(i)))return;this.downClassName=o,this.downPoint=n,this.onDown(n),this.longDownTimer=setTimeout(()=>{this.onLongDown(n),this.longDownTimer=0},this.kLongDownThresholdMs);return;case"pointerup":if(!this.downPoint)return;this.onUp(n,this.downPoint),this.longDownTimer>0&&(clearTimeout(this.longDownTimer),this.onClick(n)),this.reset();return;case"pointermove":if(this.onMove(n),!this.downPoint)return;this.isDragging?this.onDrag(n,this.downPoint):Mt(n,this.downPoint)>this.kDragThresholdMagnitude&&(this.isDragging=!0);return;default:return}}reset(){this.downClassName=void 0,this.downPoint=void 0,this.isDragging=!1}onMove(t){for(let n of this.handlers)n.onMove(t)}onDown(t){for(let n of this.handlers)n.onDown(t)}onUp(t,n){for(let o of this.handlers)o.onUp(t,n)}onClick(t){for(let n of this.handlers)n.onClick(t)}onLongDown(t){for(let n of this.handlers)n.onLongDown(t)}onDrag(t,n){for(let o of this.handlers)o.onDrag(t,n)}},D=(e,t)=>{let n=new pn(e,t);["pointerdown","pointermove","pointerup"].forEach(o=>{window.addEventListener(o,i=>{n.listener(i)})})};var k=class{constructor(){}onMove(t){}onDown(t){}onUp(t,n){}onClick(t){}onLongDown(t){}onDrag(t,n){}onDoubleClick(t){}},We=class extends k{constructor(){super();this.translated={x:0,y:0};this.keyboardEl=document.getElementById("keyboard")}onUp(t,n){this.translated.x+=t.x-n.x,this.translated.y+=t.y-n.y}onDrag(t,n){let o=this.translated.x+t.x-n.x,i=this.translated.y+t.y-n.y;this.keyboardEl.style.transform=`translate(${o}px, ${i}px)`}},Ue=class extends k{constructor(){super();this.translated={x:0,y:0};this.pointerEl=document.getElementById("pointer")}onDown(t){this.pointerEl.style.opacity="0.8",this.pointerEl.style.top=`${t.y-50/2}px`,this.pointerEl.style.left=`${t.x-50/2}px`}onUp(t,n){this.pointerEl.style.opacity="0"}onDrag(t,n){this.pointerEl.style.top=`${t.y-50/2}px`,this.pointerEl.style.left=`${t.x-50/2}px`}},ze=class extends k{constructor(t){super();this.callback=t;this.changeButton=document.getElementsByClassName("changeNoteRest")[0]}onUp(){let t=this.callback.isNoteInputMode(),n=t?"rest":"note";this.changeButton.className=this.changeButton.className.replace(t?"note":"rest",n),this.callback.change()}},_e=class extends k{constructor(t){super();this.callback=t;this.changeButton=document.getElementsByClassName("changeBeam")[0]}onUp(){let t=this.callback.getMode(),n=t==="nobeam"?"beam":"nobeam";this.changeButton.className=this.changeButton.className.replace(t,n),this.callback.change(n)}onDoubleClick(t){console.log("double")}},Ke=class extends k{constructor(){super()}onDown(t){this.target=t.target,this.target.className+=" pressed"}onUp(){!this.target||(this.target.className=this.target.className.replace(" pressed",""))}},Xe=class extends k{constructor(t){super();this.callback=t;this.candidateContainer=document.querySelector(".bars .candidateContainer")}onClick(t){this.callback.commit({type:"bar",subtype:"single"})}onLongDown(t){this.candidateContainer.style.visibility="visible"}onUp(t,n){let[o]=t.target.className.split(" ").filter(i=>i.match(/single|double|repeat/));o&&this.callback.commit({type:"bar",subtype:o}),this.candidateContainer.style.visibility="hidden"}},Ge=class extends k{constructor(t){super();this.callback=t;this.elMap=new Map([["sharp",document.querySelector(".sharp")],["natural",document.querySelector(".natural")],["flat",document.querySelector(".flat")]])}onClick(t){this.callback.next();let n=this.callback.getMode();for(let[o,i]of this.elMap.entries())o===n?i.className=i.className+" selected":i.className=o}},$e=class extends k{constructor(t){super();this.callback=t;this.posToDurationMap=new Map([["12",1],["13",2],["14",4],["22",8],["23",16],["24",32]]);this.targetClassNames=[]}get duration(){let t=this.targetClassNames.find(n=>n.match(/k[0-9][0-9]/))?.replace("k","");if(!!t)return this.posToDurationMap.get(t)}isBackspace(){return this.targetClassNames.some(t=>t==="backspace")}onDown(t){let n=t.target;this.targetClassNames=n.className.split(" ")}onClick(t){this.duration&&this.callback.commit(this.duration),this.finish()}onLongDown(t){this.isBackspace()||this.callback.startPreview(this.duration,t.x,t.y)}onDrag(t,n){this.dragDy=n.y-t.y,this.callback.updatePreview(this.duration,this.dragDy)}onUp(t,n){this.isBackspace()?this.callback.backspace():this.duration&&this.callback.commit(this.duration,this.dragDy??0),this.finish()}finish(){this.targetClassNames=[],this.dragDy=void 0,this.callback.finish()}},qe=class extends k{constructor(t){super();this.callback=t}onClick(t){let{className:n}=t.target;n.match(/.*toLeft.*/)?this.callback.back():n.match(/.*toRight.*/)&&this.callback.forward()}},Ve=class extends k{constructor(t){super();this.callback=t}onMove(t){this.callback.onMove({x:t.offsetX,y:t.offsetY})}},Ye=class extends k{constructor(t){super();this.callback=t;this.tieEl=document.querySelector(".changeTie")}onClick(t){let o=this.callback.getMode()?void 0:"tie";this.callback.change(o),this.tieEl.className=this.tieEl.className.replace(o?"notie":"tie",o?"tie":"notie")}};var dn=()=>{D(["keyboardBottom","keyboardHandle"],[new We]),D(["changeNoteRest"],[new ze(new Le)]),D(["changeBeam"],[new _e(new Ie)]),D(["grayKey","whiteKey"],[new Ke]),D(["note","rest","backspace"],[new $e(new Ae)]),D(["toLeft","toRight"],[new qe(new Re)]),D(["bars","candidate"],[new Xe(new ke)]),D(["accidentals"],[new Ge(new Te)]),D([],[new Ue]),D(["mainCanvas"],[new Ve(new Ne)]),D(["changeTie"],[new Ye(new He)])};window.addEventListener("load",()=>{console.log("start"),"serviceWorker"in navigator&&window.navigator.serviceWorker.register("./sw.js");let{canvas:e,ctx:t}=K.getById("mainCanvas"),{canvas:n}=K.getById("previewCanvas");J({leftPx:0,topPx:0,width:window.innerWidth,height:window.innerHeight,_canvas:e}),J({leftPx:0,topPx:0,width:z(),height:_(),_canvas:n}),dn(),B(),mn(t)});var mn=e=>{requestAnimationFrame(()=>{cn()&&(rn(e),Se(!1)),mn(e)})};})();
//# sourceMappingURL=out.js.map
